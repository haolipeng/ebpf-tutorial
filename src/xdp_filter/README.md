# XDP Filter ç¤ºä¾‹

## ğŸ“š ä»€ä¹ˆæ˜¯ XDPï¼Ÿ

**XDP (eXpress Data Path)** æ˜¯ Linux å†…æ ¸ä¸­æœ€æ—©çš„æ•°æ®åŒ…å¤„ç†ç‚¹ï¼Œåœ¨ç½‘ç»œé©±åŠ¨å±‚å°±å¯ä»¥å¤„ç†æ•°æ®åŒ…ï¼Œæ€§èƒ½æé«˜ã€‚

### XDP çš„ç‰¹ç‚¹

- âš¡ **æè‡´æ€§èƒ½**ï¼šåœ¨é©±åŠ¨å±‚å¤„ç†ï¼Œæ— éœ€ç»è¿‡å†…æ ¸ç½‘ç»œæ ˆ
- ğŸš€ **é›¶æ‹·è´**ï¼šç›´æ¥åœ¨é©±åŠ¨å†…å­˜ä¸­å¤„ç†æ•°æ®åŒ…
- ğŸ¯ **æ—©æœŸè¿‡æ»¤**ï¼šåœ¨æ•°æ®åŒ…è¿›å…¥ç³»ç»Ÿå‰å°±å¯ä»¥ä¸¢å¼ƒ
- ğŸ”§ **çµæ´»å¤„ç†**ï¼šå¯ä»¥ä¿®æ”¹ã€ä¸¢å¼ƒã€è½¬å‘æˆ–é‡å®šå‘æ•°æ®åŒ…

### XDP vs TC å¯¹æ¯”

| ç‰¹æ€§ | XDP | TC |
|------|-----|-----|
| **å¤„ç†ä½ç½®** | ç½‘ç»œé©±åŠ¨å±‚ | å†…æ ¸ç½‘ç»œæ ˆ |
| **æ€§èƒ½** | æé«˜ | é«˜ |
| **æ–¹å‘** | ä»… Ingressï¼ˆå…¥ç«™ï¼‰ | Ingress + Egress |
| **åŠŸèƒ½** | åŸºç¡€æ•°æ®åŒ…å¤„ç† | æ›´ä¸°å¯Œï¼ˆQoSã€åˆ†ç±»ç­‰ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | DDoS é˜²æŠ¤ã€è´Ÿè½½å‡è¡¡ | æµé‡æ•´å½¢ã€ç­–ç•¥æ§åˆ¶ |

---

## ğŸ¯ æœ¬ç¤ºä¾‹åŠŸèƒ½

è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº† XDP çš„åŸºæœ¬ç”¨æ³•ï¼š

1. **è¿‡æ»¤ ICMP æ•°æ®åŒ…**ï¼šåœ¨é©±åŠ¨å±‚ç›´æ¥ä¸¢å¼ƒ ICMP åŒ…
2. **æµé‡ç»Ÿè®¡**ï¼šç»Ÿè®¡å„åè®®ï¼ˆICMPã€TCPã€UDPï¼‰çš„æ•°æ®åŒ…æ•°é‡
3. **å®æ—¶æ˜¾ç¤º**ï¼šæ¯ 2 ç§’æ›´æ–°ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
xdp_filter/
â”œâ”€â”€ xdp_filter.bpf.c    # XDP å†…æ ¸æ€ç¨‹åº
â”œâ”€â”€ xdp_filter.c        # ç”¨æˆ·æ€åŠ è½½ç¨‹åº
â”œâ”€â”€ Makefile            # æ„å»ºè„šæœ¬
â””â”€â”€ README.md           # æœ¬æ–‡æ¡£
```

---

## ğŸ”§ XDP è¿”å›å€¼

XDP ç¨‹åºé€šè¿‡è¿”å›å€¼å†³å®šæ•°æ®åŒ…çš„å¤„ç†æ–¹å¼ï¼š

| è¿”å›å€¼ | å®å®šä¹‰ | å«ä¹‰ |
|--------|--------|------|
| `0` | `XDP_ABORTED` | å‘ç”Ÿé”™è¯¯ï¼Œä¸¢å¼ƒæ•°æ®åŒ… |
| `1` | `XDP_DROP` | **ä¸¢å¼ƒæ•°æ®åŒ…** |
| `2` | `XDP_PASS` | **å…è®¸é€šè¿‡**ï¼Œä¼ é€’åˆ°ç½‘ç»œæ ˆ |
| `3` | `XDP_TX` | ä»æ¥æ”¶æ¥å£å‘é€å›å»ï¼ˆåå¼¹ï¼‰ |
| `4` | `XDP_REDIRECT` | é‡å®šå‘åˆ°å…¶ä»–ç½‘å¡ |

---

## ğŸš€ ç¼–è¯‘å’Œè¿è¡Œ

### 1. ç¼–è¯‘

```bash
cd src/xdp_filter
make
```

ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆï¼š
- `xdp_filter` - å¯æ‰§è¡Œç¨‹åº
- `../.output/xdp_filter.bpf.o` - eBPF å­—èŠ‚ç 
- `../.output/xdp_filter.skel.h` - éª¨æ¶å¤´æ–‡ä»¶

### 2. è¿è¡Œ

```bash
# æŸ¥çœ‹ç½‘ç»œæ¥å£åç§°
ip addr show

# è¿è¡Œ XDP ç¨‹åºï¼ˆéœ€è¦ root æƒé™ï¼‰
sudo ./xdp_filter ens33   # æ›¿æ¢ä¸ºæ‚¨çš„ç½‘ç»œæ¥å£å
```

### 3. æµ‹è¯•

åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œï¼š

```bash
# ICMP åŒ…ä¼šè¢« XDP ä¸¢å¼ƒï¼ˆåœ¨é©±åŠ¨å±‚ï¼‰
ping 8.8.8.8

# TCP æµé‡æ­£å¸¸é€šè¿‡
curl https://google.com
```

### 4. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯

ç¨‹åºä¼šå®æ—¶æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼š

```
XDP Packet Statistics (Press Ctrl+C to exit)
Protocol        Packet Count
--------        ------------
TCP             1234
UDP             56

Note: ICMP packets are dropped by XDP (not counted in network stack)
```

### 5. æŸ¥çœ‹å†…æ ¸æ—¥å¿—

```bash
sudo cat /sys/kernel/debug/tracing/trace_pipe
```

é¢„æœŸè¾“å‡ºï¼š
```
xdp_filter-12345 [001] .... 123456.789: XDP: Dropping ICMP packet: 8.8.8.8 -> 192.168.1.100
```

---

## ğŸ“ XDP æ¨¡å¼è¯´æ˜

XDP æ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼ï¼š

### 1. **Generic/SKB æ¨¡å¼** (XDP_FLAGS_SKB_MODE)
- âœ… **å…¼å®¹æ€§æœ€å¥½**ï¼šæ‰€æœ‰ç½‘å¡éƒ½æ”¯æŒ
- âš ï¸ **æ€§èƒ½è¾ƒä½**ï¼šåœ¨å†…æ ¸ç½‘ç»œæ ˆä¸­æ¨¡æ‹Ÿ XDP
- ğŸ“Œ **æœ¬ç¤ºä¾‹ä½¿ç”¨æ­¤æ¨¡å¼**

### 2. **Native/Driver æ¨¡å¼** (XDP_FLAGS_DRV_MODE)
- âš¡ **æ€§èƒ½é«˜**ï¼šç›´æ¥åœ¨é©±åŠ¨ä¸­æ‰§è¡Œ
- âš ï¸ **éœ€è¦é©±åŠ¨æ”¯æŒ**ï¼šä»…éƒ¨åˆ†ç½‘å¡æ”¯æŒï¼ˆå¦‚ Intel i40eã€mlx5 ç­‰ï¼‰
- ğŸ”§ ä¿®æ”¹ä»£ç ï¼šå°† `XDP_FLAGS_SKB_MODE` æ”¹ä¸º `XDP_FLAGS_DRV_MODE`

### 3. **Hardware Offload æ¨¡å¼** (XDP_FLAGS_HW_MODE)
- ğŸš€ **æ€§èƒ½æœ€é«˜**ï¼šåœ¨ç½‘å¡ç¡¬ä»¶ä¸­æ‰§è¡Œ
- âš ï¸ **éœ€è¦ç¡¬ä»¶æ”¯æŒ**ï¼šä»…é«˜ç«¯ç½‘å¡æ”¯æŒï¼ˆå¦‚ Netronome NFPï¼‰

---

## ğŸ“Š ä»£ç è®²è§£

### å†…æ ¸æ€ç¨‹åº (xdp_filter.bpf.c)

#### 1. XDP ç¨‹åºå…¥å£ç‚¹

```c
SEC("xdp")
int xdp_filter_icmp(struct xdp_md *ctx)
```

- `SEC("xdp")` æ ‡è®°ä¸º XDP ç¨‹åº
- `struct xdp_md` æ˜¯ XDP çš„ä¸Šä¸‹æ–‡ç»“æ„

#### 2. æ•°æ®åŒ…è§£æ

```c
void *data = (void *)(long)ctx->data;
void *data_end = (void *)(long)ctx->data_end;
```

XDP ç›´æ¥è®¿é—®åŸå§‹æ•°æ®åŒ…å†…å­˜ã€‚

#### 3. è¾¹ç•Œæ£€æŸ¥

```c
if ((void *)(eth + 1) > data_end)
    return XDP_PASS;
```

å¿…é¡»è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œå¦åˆ™ verifier ä¼šæ‹’ç»åŠ è½½ã€‚

#### 4. æµé‡ç»Ÿè®¡

```c
__u64 *count = bpf_map_lookup_elem(&packet_stats, &proto);
if (count) {
    __sync_fetch_and_add(count, 1);
}
```

ä½¿ç”¨ BPF Map å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯ã€‚

### ç”¨æˆ·æ€ç¨‹åº (xdp_filter.c)

#### 1. é™„åŠ  XDP ç¨‹åº

```c
bpf_xdp_attach(ifindex, prog_fd, XDP_FLAGS_SKB_MODE, NULL);
```

- `ifindex`ï¼šç½‘ç»œæ¥å£ç´¢å¼•
- `prog_fd`ï¼šç¨‹åºæ–‡ä»¶æè¿°ç¬¦
- `XDP_FLAGS_SKB_MODE`ï¼šä½¿ç”¨é€šç”¨æ¨¡å¼

#### 2. è¯»å–ç»Ÿè®¡ä¿¡æ¯

```c
bpf_map_lookup_elem(bpf_map__fd(skel->maps.packet_stats),
                    &proto, &count);
```

ä» BPF Map è¯»å–åè®®ç»Ÿè®¡æ•°æ®ã€‚

---

## ğŸ› ï¸ å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹  1ï¼šä¸¢å¼ƒæŒ‡å®šæº IP

**ä»»åŠ¡**ï¼šæ‰©å±•ç¨‹åºï¼Œä¸¢å¼ƒæ¥è‡ªç‰¹å®š IP åœ°å€çš„æ‰€æœ‰æµé‡ã€‚

**æç¤º**ï¼š
```c
// åœ¨ XDP ç¨‹åºä¸­æ·»åŠ 
__u32 blocked_ip = bpf_htonl(0xC0A80101);  // 192.168.1.1
if (ip->saddr == blocked_ip) {
    return XDP_DROP;
}
```

### ç»ƒä¹  2ï¼šé™åˆ¶ UDP ç«¯å£

**ä»»åŠ¡**ï¼šåªå…è®¸ç‰¹å®š UDP ç«¯å£é€šè¿‡ï¼Œå…¶ä»–ç«¯å£ä¸¢å¼ƒã€‚

### ç»ƒä¹  3ï¼šå®ç°ç®€å•çš„è´Ÿè½½å‡è¡¡

**ä»»åŠ¡**ï¼šä½¿ç”¨ `XDP_TX` å°†éƒ¨åˆ†æµé‡åå¼¹å›å‘é€æ–¹ã€‚

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æŸ¥çœ‹å·²åŠ è½½çš„ XDP ç¨‹åºï¼Ÿ

```bash
# ä½¿ç”¨ ip å‘½ä»¤
ip link show ens33

# ä½¿ç”¨ bpftool
sudo bpftool net list
sudo bpftool prog list
```

### Q2: å¦‚ä½•æ‰‹åŠ¨å¸è½½ XDP ç¨‹åºï¼Ÿ

```bash
# ä½¿ç”¨ ip å‘½ä»¤
sudo ip link set dev ens33 xdp off

# æˆ–åœ¨ç¨‹åºä¸­ä½¿ç”¨
bpf_xdp_detach(ifindex, XDP_FLAGS_SKB_MODE, NULL);
```

### Q3: ä¸ºä»€ä¹ˆ ICMP ç»Ÿè®¡ä¸º 0ï¼Ÿ

å› ä¸º ICMP åŒ…åœ¨ XDP å±‚å°±è¢«ä¸¢å¼ƒäº†ï¼Œæ ¹æœ¬æ²¡æœ‰è¿›å…¥å†…æ ¸ç½‘ç»œæ ˆï¼Œæ‰€ä»¥ä¸ä¼šè¢«ç»Ÿè®¡ã€‚åªæœ‰é€šè¿‡ `XDP_PASS` çš„æ•°æ®åŒ…æ‰ä¼šè¢«è®¡æ•°ã€‚

### Q4: æˆ‘çš„ç½‘å¡æ”¯æŒ Native XDP å—ï¼Ÿ

```bash
# æŸ¥çœ‹é©±åŠ¨æ”¯æŒ
ethtool -i ens33

# å°è¯•åŠ è½½ Native æ¨¡å¼
# å¦‚æœå¤±è´¥ï¼Œè¯´æ˜ä¸æ”¯æŒ
sudo ip link set dev ens33 xdpgeneric off
sudo ip link set dev ens33 xdp obj xdp_filter.bpf.o sec xdp
```

---

## ğŸ”— å‚è€ƒèµ„æº

- [XDP Tutorial](https://github.com/xdp-project/xdp-tutorial)
- [Cilium XDP æ–‡æ¡£](https://docs.cilium.io/en/stable/bpf/)
- [Linux XDP Documentation](https://www.kernel.org/doc/html/latest/networking/xdp.html)
- [libbpf XDP API](https://libbpf.readthedocs.io/en/latest/api.html)

---

## âœ… æ€»ç»“

é€šè¿‡æœ¬ç¤ºä¾‹ï¼Œä½ å­¦ä¹ äº†ï¼š

- âœ… XDP çš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†
- âœ… XDP ç¨‹åºçš„ç¼–å†™å’ŒåŠ è½½
- âœ… XDP ä¸ TC çš„åŒºåˆ«å’Œé€‰æ‹©
- âœ… ä½¿ç”¨ BPF Map è¿›è¡Œæ•°æ®ç»Ÿè®¡
- âœ… ä¸‰ç§ XDP æ¨¡å¼çš„å·®å¼‚

**XDP çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š**
- ğŸ›¡ï¸ DDoS é˜²æŠ¤ï¼ˆåœ¨é©±åŠ¨å±‚ä¸¢å¼ƒæ¶æ„æµé‡ï¼‰
- âš–ï¸ è´Ÿè½½å‡è¡¡ï¼ˆåˆ†å‘æµé‡åˆ°ä¸åŒåç«¯ï¼‰
- ğŸ”¥ é˜²ç«å¢™ï¼ˆé«˜æ€§èƒ½åŒ…è¿‡æ»¤ï¼‰
- ğŸ“Š æµé‡ç›‘æ§ï¼ˆé›¶å¼€é”€ç»Ÿè®¡ï¼‰

**ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š**
- å°è¯• XDP_TX å’Œ XDP_REDIRECT
- ç»“åˆ XDP å’Œ TC å®ç°å®Œæ•´çš„æµé‡ç®¡ç†
- å­¦ä¹  AF_XDP è¿›è¡Œç”¨æˆ·ç©ºé—´é«˜æ€§èƒ½åŒ…å¤„ç†
